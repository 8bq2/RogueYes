local UIS = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local Me = Players.LocalPlayer
local myCharacter = Me.Character or Me.CharacterAdded:Wait()

Me.CharacterAdded:Connect(function(char) myCharacter = char end)

local LiveFolder = workspace:FindFirstChild("Live")
local NPCFolder = workspace:FindFirstChild("NPCs")

local _Flags = { ["CanPlrESP"] = true, ["CanTrinketESP"] = true }
local TrackedNPCs = { ["Fallion"] = true }

local ClassItems = {
    ["Dominus"] = "Illusionist", ["Demon Step"] = "Oni", ["Verdien"] = "Druid",
    ["Vocare"] = "Necromancer", ["Elegant Slash"] = "Whisperer", ["ShadowDash"] = "Faceless",
    ["Grapple"] = "Shinobi", ["Wing Soar"] = "Dragon Slayer", ["Tidal Trident"] = "Spearfisher",
    ["Chain Pull"] = "Deepknight", ["Hyper Body"] = "SKC", ["Darkflame Burst"] = "Wraith Knight",
    ["Calm Mind"] = "Samurai", ["Wrathful Leap"] = "Abysswalker", ["Puncture"] = "Vanguard",
    ["Lightning Elbow"] = "Dragon Sage"
}

local EdictItems = {
    ["Mederi"] = "HEALER",
    ["Analysis"] = "SEER",
    ["Verto"] = "BLADEMASTER"
}

local Functions = {}

Functions.IsActualPlayer = function(Character)
    return Character and Players:FindFirstChild(Character.Name) ~= nil
end

Functions.GetHeldItem = function(Character)
    local tool = Character:FindFirstChildOfClass("Tool")
    if tool then return tool.Name:upper() end
    return "NONE"
end

Functions.GetPlayerData = function(Character)
    local p = Players:GetPlayerFromCharacter(Character)
    if not p then return "UNDEFINED", "NONE", "FRESHIE" end
    
    local b = p:FindFirstChild("Backpack")
    local res = {Character, b}
    
    local class = "FRESHIE"
    local race = "UNDEFINED"
    local edict = "NONE"

    local function has(name)
        for _, area in pairs(res) do
            if area and area:FindFirstChild(name) then return true end
        end
        return false
    end

    local function hasInChar(name)
        return Character:FindFirstChild(name) ~= nil
    end

    -- 1. Identify Class
    for item, name in pairs(ClassItems) do
        if has(item) then class = name:upper() break end
    end

    -- 2. Identify Edict
    for item, name in pairs(EdictItems) do
        if has(item) then edict = name break end
    end

    -- 3. Identify Race
    if hasInChar("AzaelHorn") then race = "AZAEL" -- Azael Check
    elseif has("Decompose") then race = "SCROOM"
    elseif has("World's Pulse") and class ~= "DRUID" then race = "DZIN"
    elseif has("Repair") then
        race = has("Exhaust") and "METASCROOM" or "GAIAN"
    elseif has("Shift") then race = "MADRASIAN"
    elseif has("Tempest Soul") then race = "VIND"
    elseif has("Dissolve") then race = "FISCHERAN"
    elseif has("Flock") then race = "MORVID"
    elseif (has("Soul Rip") or has("MasteredRune")) and class ~= "WRAITH KNIGHT" then race = "DINAKERI"
    elseif has("Emulate") then race = "NAVARAN"
    elseif has("Respirare") then race = "KASPARAN"
    elseif has("Shoulder Throw") and has("MercenaryCarry") then race = "ASHIIN"
    elseif has("Flood") then race = "RIGAN"
    elseif has("Bloodline") then race = "HASELDAN"
    elseif has("Galvanize") then race = "CONSTRUCT"
    end

    return race, edict, class
end

Functions.ApplyESP = function(Character: Model, isNPC: boolean)
    if not _Flags["CanPlrESP"] or (not isNPC and (Character == myCharacter or not Functions.IsActualPlayer(Character))) then return end

    if (Character:FindFirstChild("ESPHighlight")) then Character.ESPHighlight:Destroy() end
    local head = Character:FindFirstChild("Head")
    if head and head:FindFirstChild("DistanceGui") then head.DistanceGui:Destroy() end

    local Highlight = Instance.new("Highlight", Character)
    Highlight.Name = "ESPHighlight"
    Highlight.FillTransparency, Highlight.DepthMode = 1, Enum.HighlightDepthMode.AlwaysOnTop
    Highlight.OutlineColor = isNPC and Color3.new(0, 0.5, 1) or Color3.new(1, 0, 0)

    local billboard = Instance.new("BillboardGui", head)
    billboard.Name, billboard.AlwaysOnTop, billboard.Size = "DistanceGui", true, UDim2.new(0, 250, 0, 100)
    billboard.StudsOffset = Vector3.new(0, 4, 0)

    local textlabel = Instance.new("TextLabel", billboard)
    textlabel.BackgroundTransparency, textlabel.Size, textlabel.TextColor3 = 1, UDim2.new(1, 0, 1, 0), Color3.new(1, 1, 1)
    textlabel.TextScaled = false
    textlabel.TextSize = 12 
    textlabel.Font = Enum.Font.SourceSansBold
    Instance.new("UIStroke", textlabel).Thickness = 1

    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not Character or not Character.Parent or not _Flags["CanPlrESP"] then
            billboard:Destroy(); Highlight:Destroy(); connection:Disconnect() return
        end

        if myCharacter and myCharacter:FindFirstChild("HumanoidRootPart") and Character:FindFirstChild("HumanoidRootPart") then
            local dist = (myCharacter.HumanoidRootPart.Position - Character.HumanoidRootPart.Position).Magnitude
            if isNPC then
                textlabel.Text = string.format("%s\n%d studs", Character.Name:upper(), math.floor(dist + 0.5))
            else
                local race, edict, class = Functions.GetPlayerData(Character)
                local heldItem = Functions.GetHeldItem(Character)
                local pObj = Players:FindFirstChild(Character.Name)
                local username = pObj and pObj.DisplayName:upper() or Character.Name:upper()
                
                textlabel.Text = string.format("%s\n%s | %s | %s\nHOLDING: %s\n%d STUDS", 
                    username, race, edict, class, heldItem, math.floor(dist + 0.5))
            end
        end
    end)
end

Functions.TagTrinket = function(t)
    if not _Flags["CanTrinketESP"] then return end
    if (t:IsA("BasePart") or t:IsA("MeshPart")) and t:FindFirstChild("ID") then
        if not t:FindFirstChild("ItemHighlight") then
            local h = Instance.new("Highlight", t)
            h.Name, h.FillTransparency, h.OutlineColor = "ItemHighlight", 1, Color3.new(0, 1, 0)
            h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end
    end
end

Functions.ItemESP = function()
    for _, t in pairs(workspace:GetChildren()) do Functions.TagTrinket(t) end
end

workspace.ChildAdded:Connect(function(child) task.wait(0.1) Functions.TagTrinket(child) end)

if LiveFolder then
    for _, m in pairs(LiveFolder:GetChildren()) do if m:IsA("Model") then task.spawn(Functions.ApplyESP, m, false) end end
    LiveFolder.ChildAdded:Connect(function(c) task.wait(0.6) if c:IsA("Model") then Functions.ApplyESP(c, false) end end)
end

if NPCFolder then
    for _, m in pairs(NPCFolder:GetChildren()) do if TrackedNPCs[m.Name] then task.spawn(Functions.ApplyESP, m, true) end end
end

task.spawn(Functions.ItemESP)

UIS.InputBegan:Connect(function(input, gpe)
    if gpe or input.KeyCode ~= Enum.KeyCode.Z then return end
    _Flags["CanPlrESP"] = not _Flags["CanPlrESP"]
    _Flags["CanTrinketESP"] = _Flags["CanPlrESP"]
    if not _Flags["CanPlrESP"] then
        for _, v in pairs(workspace:GetDescendants()) do
            if v.Name == "ESPHighlight" or v.Name == "DistanceGui" or v.Name == "ItemHighlight" then v:Destroy() end
        end
    else
        for _, m in pairs(LiveFolder:GetChildren()) do if m:IsA("Model") then task.spawn(Functions.ApplyESP, m, false) end end
        for _, m in pairs(NPCFolder:GetChildren()) do if TrackedNPCs[m.Name] then task.spawn(Functions.ApplyESP, m, true) end end
        task.spawn(Functions.ItemESP)
    end
end)
